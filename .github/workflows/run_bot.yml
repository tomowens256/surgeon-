name: Run Trading Bot

on:
  schedule:
    - cron: '0 16 * * 1-5'  # Mon-Fri 16:00 UTC (19:00 EAT)
    - cron: '0 22 * * 1-5'  # Mon-Fri 22:00 UTC (01:00 EAT next day)
    - cron: '0 4 * * 2-6'   # Tue-Sat 04:00 UTC (07:00 EAT)
  workflow_dispatch:
  # Add pull_request_target for fork compatibility
  pull_request_target:
    branches: [ main ]

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    # Add explicit permissions for fork workflows
    permissions:
      contents: write
      actions: write
    strategy:
      matrix:
        python-version: ['3.10']
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
        # Checkout from PR head for fork compatibility
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libopenblas-dev
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test Telegram connection
      run: |
        echo "Testing Telegram connectivity..."
        response=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d '{"chat_id":"'${{ secrets.TELEGRAM_CHAT_ID }}'", "text":"üöÄ Trading Bot Started: ${{ github.run_id }}"}' \
          https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage)
        
        if [[ $response == *"\"ok\":true"* ]]; then
          echo "‚úÖ Telegram connection successful!"
        else
          echo "‚ùå Telegram connection failed: $response"
          exit 1
        fi

    - name: Run Trading Bot with Auto-Chaining
      env:
        OANDA_ACCOUNT_ID: ${{ secrets.OANDA_ACCOUNT_ID }}
        OANDA_API_KEY: ${{ secrets.OANDA_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        # Use PAT token for workflow dispatch
        DISPATCH_TOKEN: ${{ secrets.DISPATCH_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        # Run main trading script with timeout
        timeout 340m python -u main.py | tee run.log
        
        # Capture exit status
        EXIT_CODE=$?
        
        # Send log to Telegram
        LOG_CONTENT=$(tail -c 4000 run.log | sed 's/\x1b\[[0-9;]*m//g')
        curl -s -X POST \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\":\"$TELEGRAM_CHAT_ID\", \"text\":\"Bot exited with code $EXIT_CODE\n\nLog snippet:\n$LOG_CONTENT\"}" \
          https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage
        
        # Chain next run if normal exit
        if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 124 ]; then
          echo "üîÑ Chaining next workflow run"
          
          # Calculate next run time (5h50m from now)
          NEXT_RUN_TIME=$(date -u -d "+5 hours 50 minutes" +"%H:%M UTC")
          
          # Use PAT token for reliable workflow dispatch
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $DISPATCH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/workflows/$GITHUB_WORKFLOW_ID/dispatches" \
            -d '{"ref":"${{ github.ref }}"}'
          
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"$TELEGRAM_CHAT_ID\", \"text\":\"‚ôªÔ∏è Chaining next run at ${NEXT_RUN_TIME}\"}" \
            https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage
        else
          echo "‚õî Not chaining due to error exit"
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"$TELEGRAM_CHAT_ID\", \"text\":\"‚ùå Bot stopped, not chaining due to error\"}" \
            https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage
        fi
